<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Controle de Relé</title>

<style>
    body {
        margin: 0;
        padding: 0;
        background: #0a0a0a;
        color: #fff;
        font-family: Arial, sans-serif;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        min-height: 100vh;
    }

    .card {
        background: #111;
        width: 92%;
        max-width: 420px;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 0 12px #00eaff33;
    }

    h1 {
        text-align: center;
        margin: 0 0 20px 0;
        font-size: 24px;
        color: #00eaff;
    }

    .info {
        font-size: 18px;
        margin: 10px 0;
        line-height: 24px;
    }

    .label {
        color: #00aaff;
        font-weight: bold;
    }

    .loading {
        text-align: center;
        margin: 20px 0;
        font-size: 18px;
        color: #00eaff;
        animation: blink 1s infinite;
    }

    @keyframes blink { 50% { opacity: 0.3; } }

    button {
        width: 100%;
        padding: 16px;
        margin-top: 20px;
        font-size: 20px;
        border: none;
        border-radius: 8px;
        background: #00a6ff;
        color: #000;
        font-weight: bold;
    }

    button:disabled {
        background: #555;
        color: #ccc;
    }

    #statusMsg {
        margin-top: 16px;
        text-align: center;
        font-size: 18px;
    }

    .spin {
        width: 28px;
        height: 28px;
        border: 4px solid #00eaff55;
        border-top: 4px solid #00eaff;
        border-radius: 50%;
        margin: 12px auto;
        animation: spin 0.9s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>
<body>

<div class="card">

    <h1>Controle do Relé</h1>

    <div id="loadingStatus" class="loading">
        Carregando status da ESP...
    </div>

    <div id="infoBox" style="display:none;">
        <div class="info"><span class="label">IP Local:</span> <span id="ipLocal">--</span></div>
        <div class="info"><span class="label">IP Público:</span> <span id="ipPublico">--</span></div>

        <button id="btnRele" onclick="acionarRele()" disabled>Acionar Relé</button>
        <div id="statusMsg"></div>
    </div>

</div>

<script>
const ESP_URL = "http://191.183.134.126:1010";

const btnRele = document.getElementById("btnRele");
const statusMsg = document.getElementById("statusMsg");
const loadingStatus = document.getElementById("loadingStatus");
const infoBox = document.getElementById("infoBox");
const ipLocal = document.getElementById("ipLocal");
const ipPublico = document.getElementById("ipPublico");

/* =============================
   ANTIFLOOD
   ============================= */

const MAX_TENTATIVAS = 4;
const TEMPO_BLOQUEIO = 2 * 60 * 1000;

function getFloodData() {
    const data = localStorage.getItem("floodData");
    return data ? JSON.parse(data) : { tentativas: [], bloqueadoAte: 0 };
}

function saveFloodData(data) {
    localStorage.setItem("floodData", JSON.stringify(data));
}

function registrarTentativa() {
    let data = getFloodData();
    const agora = Date.now();
    data.tentativas = data.tentativas.filter(t => agora - t < TEMPO_BLOQUEIO);
    data.tentativas.push(agora);
    if (data.tentativas.length >= MAX_TENTATIVAS) {
        data.bloqueadoAte = agora + TEMPO_BLOQUEIO;
    }
    saveFloodData(data);
}

function verificarBloqueio() {
    let data = getFloodData();
    const agora = Date.now();

    if (agora < data.bloqueadoAte) {
        bloquearBotao(data.bloqueadoAte - agora);
        return true;
    }

    return false;
}

function bloquearBotao(tempoRestante) {
    btnRele.disabled = true;

    function atualizar() {
        const segundos = Math.ceil(tempoRestante / 1000);
        statusMsg.innerHTML = `<span style="color:#ff5050;">Aguarde ${segundos}s...</span>`;
        tempoRestante -= 1000;

        if (tempoRestante <= 0) {
            statusMsg.innerHTML = "";
            btnRele.disabled = false;
            let data = getFloodData();
            data.tentativas = [];
            data.bloqueadoAte = 0;
            saveFloodData(data);
        } else setTimeout(atualizar, 1000);
    }
    atualizar();
}

/* =============================
   Fetch com timeout
   ============================= */

function fetchTimeout(url, options = {}, timeout = 4000) {
    return Promise.race([
        fetch(url, options),
        new Promise((_, reject) =>
            setTimeout(() => reject(new Error("timeout")), timeout)
        )
    ]);
}

/* =============================
   Carregar status da ESP
   ============================= */

window.onload = () => {
    fetchTimeout(`${ESP_URL}/status`)
        .then(r => {
            if (!r.ok) throw new Error("http");
            return r.json();
        })
        .then(json => {
            ipLocal.textContent = json.local;
            ipPublico.textContent = json.publico;

            loadingStatus.style.display = "none";
            infoBox.style.display = "block";

            if (!verificarBloqueio()) btnRele.disabled = false;
        })
        .catch(err => {
            let erro = "Erro ao conectar à ESP!";
            if (err.message === "timeout") erro = "Tempo excedido.";
            if (err.message === "Failed to fetch") erro = "ESP Offline.";

            loadingStatus.innerHTML = `
                ${erro}<br><br>
                <button onclick="location.reload()" style="
                    padding:10px 18px;
                    font-size:16px;
                    border:none;
                    border-radius:8px;
                    background:#00a6ff;
                    color:#000;
                    font-weight:bold;">
                    Tentar novamente
                </button>
            `;
        });
};

/* =============================
   Acionar relé
   ============================= */

function acionarRele() {
    if (verificarBloqueio()) return;

    registrarTentativa();
    if (verificarBloqueio()) return;

    btnRele.disabled = true;
    statusMsg.innerHTML = `<div class="spin"></div>Enviando...`;

    fetchTimeout(`${ESP_URL}/pulse?rl=1`, {}, 5000)
        .then(r => {
            if (!r.ok) throw new Error("http");
            return r.text();
        })
        .then(txt => {
            if (txt.trim().toUpperCase().includes("PULSO OK"))
                statusMsg.innerHTML = `<span style="color:#00ff97;">COMANDO ENVIADO!</span>`;
            else
                statusMsg.innerHTML = `<span style="color:#ff5050;">Resposta inválida.</span>`;

            setTimeout(() => {
                if (!verificarBloqueio()) btnRele.disabled = false;
            }, 1000);
        })
        .catch(() => {
            statusMsg.innerHTML = `<span style="color:#ff5050;">Erro ao enviar comando.</span>`;
            if (!verificarBloqueio()) btnRele.disabled = false;
        });
}
</script>

</body>
</html>
