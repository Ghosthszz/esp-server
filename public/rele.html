<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Controle de Relé</title>

<style>
    body {
        margin: 0;
        padding: 0;
        background: #0a0a0a;
        color: #fff;
        font-family: Arial, sans-serif;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        overflow: hidden;
        zoom: 100%;
    }

    h1 {
        margin: 0 0 28px 0;
        font-size: 32px;
        color: #00eaff;
        text-shadow: 0 0 8px #00eaff;
        text-align: center;
    }

    .card {
        background: #111;
        width: 95%;
        max-width: 520px;
        padding: 32px;
        border-radius: 20px;
        box-shadow: 0 0 25px #00eaff33;
        transform: scale(1.22);
    }

    .info {
        font-size: 22px;
        margin: 16px 0;
        line-height: 30px;
    }

    .label {
        color: #00aaff;
        font-weight: bold;
        font-size: 22px;
    }

    .loading {
        font-size: 24px;
        margin-top: 20px;
        color: #00eaff;
        animation: blink 1s infinite;
        text-align: center;
    }

    @keyframes blink { 50% { opacity: 0.3; } }

    button {
        width: 100%;
        padding: 22px;
        font-size: 26px;
        font-weight: bold;
        border: none;
        border-radius: 14px;
        background: #00a6ff;
        color: #000;
        margin-top: 25px;
        transition: 0.2s;
    }

    button:disabled {
        background: #444;
        color: #777;
    }

    button:not(:disabled):hover {
        transform: scale(1.05);
        background: #008fd1;
    }

    #statusMsg {
        margin-top: 25px;
        font-size: 22px;
        text-align: center;
    }

    .spin {
        width: 38px;
        height: 38px;
        border: 5px solid #00eaff55;
        border-top: 5px solid #00eaff;
        border-radius: 50%;
        margin: 18px auto;
        animation: spin 0.9s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>
<body>

<div class="card">

    <h1>Controle do Relé</h1>

    <div id="loadingStatus" class="loading">
        Carregando status da ESP...
    </div>

    <div id="infoBox" style="display:none;">
        <div class="info"><span class="label">IP Local:</span> <span id="ipLocal">--</span></div>
        <div class="info"><span class="label">IP Público:</span> <span id="ipPublico">--</span></div>

        <button id="btnRele" onclick="acionarRele()" disabled>Acionar Relé</button>

        <div id="statusMsg"></div>
    </div>

</div>

<script>
const ESP_URL = "http://191.183.134.126:1010";

const btnRele = document.getElementById("btnRele");
const statusMsg = document.getElementById("statusMsg");
const loadingStatus = document.getElementById("loadingStatus");
const infoBox = document.getElementById("infoBox");
const ipLocal = document.getElementById("ipLocal");
const ipPublico = document.getElementById("ipPublico");

/* =============================
   SISTEMA ANTIFLOOD (4 tentativas / 5 minutos)
   ============================= */

const MAX_TENTATIVAS = 4;
const TEMPO_BLOQUEIO = 2 * 60 * 1000; // 5 minutos em ms

function getFloodData() {
    const data = localStorage.getItem("floodData");
    return data ? JSON.parse(data) : { tentativas: [], bloqueadoAte: 0 };
}

function saveFloodData(data) {
    localStorage.setItem("floodData", JSON.stringify(data));
}

function registrarTentativa() {
    let data = getFloodData();
    
    const agora = Date.now();
    data.tentativas = data.tentativas.filter(t => agora - t < TEMPO_BLOQUEIO);
    data.tentativas.push(agora);

    if (data.tentativas.length >= MAX_TENTATIVAS) {
        data.bloqueadoAte = agora + TEMPO_BLOQUEIO;
    }

    saveFloodData(data);
}

function verificarBloqueio() {
    let data = getFloodData();
    const agora = Date.now();

    if (agora < data.bloqueadoAte) {
        bloquearBotao(data.bloqueadoAte - agora);
        return true;
    }

    return false;
}

function bloquearBotao(tempoRestante) {
    btnRele.disabled = true;

    function atualizarContador() {
        const segundos = Math.ceil(tempoRestante / 1000);
        statusMsg.innerHTML = `
            <span style="color:#ff5050; font-weight:bold;">
                Muitas tentativas! Aguarde ${segundos}s para tentar novamente.
            </span>
        `;

        tempoRestante -= 1000;

        if (tempoRestante <= 0) {
            statusMsg.innerHTML = "";
            btnRele.disabled = false;

            let data = getFloodData();
            data.tentativas = [];
            data.bloqueadoAte = 0;
            saveFloodData(data);
        } else {
            setTimeout(atualizarContador, 1000);
        }
    }

    atualizarContador();
}

/* =============================
   Fetch com timeout
   ============================= */

function fetchTimeout(url, options = {}, timeout = 4000) {
    return Promise.race([
        fetch(url, options),
        new Promise((_, reject) => setTimeout(() => reject(new Error("timeout")), timeout))
    ]);
}

/* =============================
   Carregar dados da ESP
   ============================= */

window.onload = () => {
    fetchTimeout(`${ESP_URL}/status`)
        .then(r => {
            if (!r.ok) throw new Error("http");
            return r.json();
        })
        .then(json => {
            ipLocal.textContent = json.local;
            ipPublico.textContent = json.publico;

            loadingStatus.style.display = "none";
            infoBox.style.display = "block";

            if (!verificarBloqueio()) {
                btnRele.disabled = false;
            }
        })
        .catch(err => {
            let erro = "Erro ao conectar à ESP!";

            if (err.message === "timeout") erro = "Erro: Tempo excedido ao ler status da ESP.";
            if (err.message === "Failed to fetch") erro = "ESP Offline ou rede indisponível.";

            loadingStatus.innerHTML = `
                ${erro}<br><br>
                <button onclick="location.reload()" style="
                    margin-top:15px;
                    padding:12px 22px;
                    font-size:20px;
                    border:none;
                    border-radius:10px;
                    background:#00a6ff;
                    color:#000;
                    font-weight:bold;
                    cursor:pointer;
                ">
                    Tentar novamente
                </button>
            `;
        });
};

/* =============================
   Acionar o relé
   ============================= */

function acionarRele() {
    if (verificarBloqueio()) return;

    registrarTentativa();
    if (verificarBloqueio()) return;

    btnRele.disabled = true;

    statusMsg.innerHTML = `
        <div class="spin"></div>
        <span style="color:#00eaff">Acionando relé...</span>
    `;

    fetchTimeout(`${ESP_URL}/pulse?rl=1`, {}, 5000)
        .then(r => {
            if (!r.ok) {
                if (r.status === 404) throw new Error("404");
                if (r.status === 500) throw new Error("500");
                throw new Error("http");
            }
            return r.text();
        })
        .then(txt => {
            let resp = txt.trim().toUpperCase();

            if (resp.includes("PULSO OK")) {
                statusMsg.innerHTML = `
                    <span style="color:#00ff97; font-weight:bold;">
                        RELÉ ACIONADO COM SUCESSO!
                    </span>
                `;
            } else {
                statusMsg.innerHTML = `
                    <span style="color:#ff5050;">
                        Resposta inválida recebida: ${txt}
                    </span>
                `;
            }

            setTimeout(() => {
                if (!verificarBloqueio()) btnRele.disabled = false;
            }, 1300);
        })
        .catch(err => {
            let erro = "Erro desconhecido.";

            if (err.message === "timeout") erro = "Erro: A ESP demorou demais (timeout).";
            if (err.message === "Failed to fetch") erro = "Erro: ESP offline.";
            if (err.message === "404") erro = "Erro 404: /pulse não existe.";
            if (err.message === "500") erro = "Erro interno 500.";
            if (err.message === "http") erro = "Erro HTTP na ESP.";

            statusMsg.innerHTML = `<span style="color:#ff5050;">${erro}</span>`;

            if (!verificarBloqueio()) btnRele.disabled = false;
        });
}
</script>

</body>
</html>
 
